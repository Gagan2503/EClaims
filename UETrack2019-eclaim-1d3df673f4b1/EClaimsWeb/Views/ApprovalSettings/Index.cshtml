@model IEnumerable<EClaimsEntities.Models.MstApprovalMatrix>

@{
    ViewData["Title"] = "Index";
}

@section Styles{
    <environment names="Development">
        <link rel="stylesheet" href="~/vendors/select2/select2.min.css" asp-append-version="true">
        <link rel="stylesheet" href="~/vendors/select2-bootstrap-theme/select2-bootstrap.min.css" asp-append-version="true">
        <link rel="stylesheet" href="~/vendors/datatables.net-bs4/dataTables.bootstrap4.css" asp-append-version="true" />
    </environment>

    <environment names="Staging,Production">
        <link href="~/_bundles/department.min.css" rel="stylesheet" asp-append-version="true" />
    </environment>
}

<div class="row">
    <div class="col-md-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="mb-0 font-weight-bold">Approval Settings</h4>
                <form class="forms-sample mt-4">
                    <div class="row">
                        @*<div class="form-group col-md-6">
                                <label class="required">Module</label>
                                <select class="js-example-basic-single w-100">
                                    <option value="WY">Claims</option>
                                    <option value="HQ">HR</option>
                                </select>
                            </div>*@
                        <div class="col-md-6" form-group>
                            <label class="control-label">Module</label>
                            <select id="ModuleId" class="form-control" asp-items="@(new SelectList(@ViewBag.ModuleList,"ModuleId","ModuleName"))">
                                @*<option>Select Module</option>*@
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        @*<div class="form-group col-md-6">
                                <label class="required">Claims</label>
                                <select class="js-example-basic-single w-100">
                                    <option value="HQ">Mileage</option>
                                    <option value="WY">Expense</option>
                                    <option value="WYH">PV-Cheque</option>
                                    <option value="WYH">PV-GIRO</option>
                                </select>
                            </div>*@
                        <div class="col-md-6" form-group>
                            <label class="control-label">Claims</label>
                            <select id="ScreenID" class="form-control" >
                                @*<option>Select Claim</option>*@
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <button type="submit" class="btn btn-primary mr-2" id="btn_submit" onclick="return getScreenDetails();">Filter</button>
                        <button class="btn btn-light">Reset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="row" id="ViewDetails">
    <div class="col-md-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="mb-0 font-weight-bold">Update Approval Settings</h4>
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="table-responsive">
                            <table id="tblApproval" class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>
                                        </th>
                                        <th>
                                            Screen Name
                                        </th>
                                        <th>
                                            Approval Required
                                        </th>
                                        <th>
                                            Verification Levels
                                        </th>
                                        <th>
                                            Approval Levels
                                        </th>
                                        <th>
                                            Action
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                  
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts
{
    <environment names="Development">
        <script src="~/vendors/typeahead.js/typeahead.bundle.min.js" asp-append-version="true"></script>
        <script src="~/vendors/select2/select2.min.js" asp-append-version="true"></script>
        <script src="~/vendors/datatables.net/jquery.dataTables.js" asp-append-version="true"></script>
        <script src="~/vendors/datatables.net-bs4/dataTables.bootstrap4.js" asp-append-version="true"></script>
        <script src="~/js/file-upload.js"></script>
        <script src="~/js/typeahead.js"></script>
        <script src="~/js/select2.js"></script>
        <script src="~/js/data-table.js"></script>
        <script type="text/javascript">

            $(document).ready(function () {
                getScreensByModule();



            });

             var strInvoices = "";
                var Invoiceids = [];
                var data;


                    //data= $('.datatable').dataTable({
                    //    "sPaginationType": "bootstrap",
                    //    "sDom": "<'tableHeader'<l><'clearfix'f>r>t<'tableFooter'<i><'clearfix'p>>",
                    //    "iDisplayLength": 10
                    //});
                    data = $('#tblApproval').dataTable({
                        "processing": true,
                        "serverSide": true,
                        "sServerMethod": "GET",
                        "pagingType": "full_numbers",
                        "sDom": "<'tableHeader'<l><'clearfix'f>r>t<'tableFooter'<i><'clearfix'p>>",
                        "sAjaxSource": "@Url.Content("~/ApprovalSettings/AjaxHandler/")",
                        "iDisplayLength": 50,

                        "fnServerParams": function (aoData) {
                            aoData.push(
                                { "name": "ddlModule", "value": $("#ModuleId").val() },
                                { "name": "ddlScreen", "value": $("#ScreenID").val() }
                                //{ "name": "ddlProject", "value": $("#ddlProject").val() }
                            );
                        },

                        "columnDefs": [
                            {
                                'bSortable': false,
                                'aTargets': [0, 2, 3, 4, 5]
                            },
                            {
                                "targets": [0], //Comma separated values
                                "className": "hide_column",
                                "searchable": true
                            }
                        ]
                    });
                    var table = $('#tblApproval').DataTable();
                    //$('.no-search .dataTables_length select').chosen();

     $("#ModuleId").change(function () {
        getScreensByModule();
     });

         var getScreensByModule = function () {
         $.ajax({
            url: '@Url.Action("getScreensByModule", "ApprovalSettings")',
            type: 'GET',
             data: {
                 moduleID: $('#ModuleId').val(),
             },
             success: function (data) {
                 $('#ScreenID').find('option').remove()
                 $(data).each(
                     function (index, item) {
                         $('#ScreenID').append('<option value="' + item.screenID + '">' + item.screenName + '</option>')
                     });
            },
            error: function () {
            }
           });
            }
  
            function getScreenDetails() {

                var modulename = $('#ModuleId').val();
                if (!modulename) {
                    //$('#error_ddlModule').addClass("ShowBubble");
                    //$('#error_ddlModule').removeClass("HideBubble");
                    //$('#error_ddlModule').focus();
                    //AutoHide("#error_ddlModule", "3000");
                    return false
                }
                var ddlScreen = $('#ScreenID').val();
                if (!ddlScreen) {
                    //$('#spScreen').addClass("ShowBubble");
                    //$('#spScreen').removeClass("HideBubble");
                    //$('#spScreen').focus();
                    //AutoHide("#spScreen", "3000");
                    return false
                }
                var oTable = $('#tblApproval').dataTable();
                oTable.fnFilter();
            }

            function UpdateApprover() {
                alert('hello');
                var val = $("#txtid").val();
                var Params1 = [];
                var ddlApprover;
                var AmountFrom;
                var AmountTo;
                alert(val);
                $('#tblOne tbody').find('tr').each(function (i) {
                    var $tds = $(this).find('td');
                    ddlVerifier = $tds.find('#ddlVerifier').val();
                    ddlApprover = $tds.find('#ddlApprover').val();
                    AmountFrom = $tds.find('#txtAmountFrom').val();
                    AmountTo = $tds.find('#txtAmountTo').val();
                    alert(val);
                    alert(ddlVerifier);
                    alert(ddlApprover);
                    alert(AmountFrom);
                    alert(AmountTo);

                    Params1.push({ AMID: val, Verifier: ddlVerifier, Approver: ddlApprover, AmountFrom: AmountFrom, AmountTo: AmountTo });
                    return true;
                });
                }

               function Updatedata()
                {

                    var Params  = new Array();
                    //  //  data.fnDestroy();
                    //var array = strInvoices.split(",");
                    //alert('array ' + array);

                    //    $.each(array, function (i) {

                    //        var val = array[i].trim();
                    //        var active;
                    var formData = new FormData();
                            $('#tblApproval tbody').find('tr').each(function (i) {

                                   var $tds = $(this).find('td'),
                                   productId = $tds.eq(0).text(),
                                   productId=productId.trim();
                                var val = $("#txtid").val();
                                if (val) {

                                   // var status = $(this).find('#status');
                                    var status = $tds.find("#ApprovalRequired").toggle(this.checked);
                                    if(status.is(':checked'))
                                    {

                                    active=true;

                                    }
                                    else
                                    {
                                    active=false;
                                    }

                                    var Verification = $tds.find('#VerificationLevels').val();
                                    var Approval = $tds.find('#ApprovalLevels').val();

                                    Params.push({AMID:val,ApprovalRequired:active,VerificationLevels:Verification,ApprovalLevels:Approval});

                                }


                            });
                             formData.append('data', JSON.stringify(Params));
                             //var listdata = JSON.stringify({ 'listdata': Params });
                                        $.ajax({
                                            type: "POST",
                                            url: "/ApprovalSettings/SaveItems",
                                            data: formData,
                                            contentType: "application/json; charset=utf-8",
                                            dataType: "json",
                                            processData: false,
                                            contentType: false,
                                        success: function (data) {
                                            if (data) {
                                              $("#msgspan").fadeIn();
                                             $("#NotificationMsg").html('Approval Matrix Updated Successfully');
                                             $("#msgspan").fadeOut(1500);
                                            }
                                            }
                                     });
                        //data.DataTable({
                        //    "sPaginationType": "bootstrap",
                        //    "sDom": "<'tableHeader'<l><'clearfix'f>r>t<'tableFooter'<i><'clearfix'p>>",
                        //    "iDisplayLength": 10
                        //});

                      //  window.location.reload();
                        //var oTable = $('#tblApproval').dataTable();
                        //oTable.fnFilter();
                }

                function UpdateApprover() {
                    var val = $("#txtid").val();

                    //var data = { AMID: 1, Verifier: 3, Approver: 9, AmountFrom: 5656, AmountTo: 8989 };
                    //var formData = new FormData();
                    //formData.append('data', JSON.stringify(data));
                    //var data = { AMID: 1, Verifier: 3, Approver: 9, AmountFrom: 5656, AmountTo: 8989 };
                    var formData = new FormData();
                    //formData.append('data', JSON.stringify(data));

                    var clsApprovers = new Array();
                    //var clsApprover = {};
                    $('#tblOne tbody').find('tr').each(function (i) {
                        var $tds = $(this).find('td');
                        ddlVerifier = $tds.find('#ddlVerifier').val();
                        ddlApprover = $tds.find('#ddlApprover').val();
                        AmountFrom = $tds.find('#txtAmountFrom').val();
                        AmountTo = $tds.find('#txtAmountTo').val();
                        var clsApprover = {};
                        //clsApprover.ApprovalLevels = 4;
                        //clsApprover.VerificationLevels = 6;
                        clsApprover.AMID = val;
                        clsApprover.Verifier = ddlVerifier;
                        clsApprover.Approver = ddlApprover;
                        clsApprover.AmountFrom = AmountFrom;
                        clsApprover.AmountTo = AmountTo;

                        //alert('clsApprover ' + clsApprover);
                        clsApprovers.push(clsApprover);
                    });
                    formData.append('data', JSON.stringify(clsApprovers));

                  //var val=$("#txtid").val();
                  //var Params1 = [];
                  //      var ddlApprover;
                  //       var AmountFrom;
                  //        var AmountTo;
                //    $('#tblOne tbody').find('tr').each(function (i) {
                //     var $tds = $(this).find('td');
                //      ddlVerifier =  $tds.find('#ddlVerifier').val();
                //      ddlApprover =  $tds.find('#ddlApprover').val();
                //      AmountFrom =  $tds.find('#txtAmountFrom').val();
                //        AmountTo = $tds.find('#txtAmountTo').val();
                //        alert('ddlVerifier '+ddlVerifier);
                //        alert(ddlApprover);
                //        alert(AmountFrom);
                //        alert(AmountTo);
                //        Params1.push({AMID:val,Verifier:ddlVerifier,Approver:ddlApprover,AmountFrom:AmountFrom,AmountTo:AmountTo});
                //        return true;
                //});
                    if (clsApprovers.length!=0)
                {
                    //var listdata1 = JSON.stringify({ 'listdata': Params1 });
                        //alert('listdata1 ' + clsApprovers);
                        $.ajax({
                            type: "POST",
                            url: "/ApprovalSettings/SaveApprover",
                            data: formData,
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            processData: false,
                            contentType: false,
                           // data: clsApprovers,
                            //data: { clsApprover: JSON.stringify(clsApprover) },
                            //contentType: "application/json; charset=utf-8",
                            //dataType: "json",
                            //contentType: 'application/json; charset=utf-8',
                            //dataType: 'json',
                            //type: 'POST',
                            //url: "/ApprovalSettings/SaveApprover",
                            //data: listdata1,
                            success: function (data) {
                                if (data) {
                                    //alert("Successfully saved");
                                    //$("#btnsaveUser").trigger( "click" );
                                   // $("#dialog1").dialog('close')
                                   // $("#tblOne").find("tr:not(:nth-child(1)):not(:nth-child(1))").remove();
                                    //deactivate();

                                    Updatedata();

                                  $("#msgspan").fadeIn();
                                 $("#NotificationMsg").html('Approver Added Successfully');
                                 $("#msgspan").fadeOut(1500);
                                }

                                }
                                });

            //window.location.reload();
                    }
                }






                function EditUser(args) {
                    $(function () {
                        // var ddlApprover = $("#ddlApprover");
                        //  ddlApprover.empty().append('<option selected="selected" value="0" disabled = "disabled">Loading.....</option>');
                        $.ajax({
                            type: "POST",
                            url: "/ApprovalSettings/ReturnJSONDataToAJax",
                            data: '{}',
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            success: function (response) {
                                $(response).each(function () {
                                    //alert('binding dropdown values');
                                    $("#ddlVerifier").append($("<option></option>").val(this.userID).html(this.name));
                                    $("#ddlApprover").append($("<option></option>").val(this.userID).html(this.name));
                                });

                                var Verification;
                                var V;
                                var A;
                                //alert(args);
                                $("#txtid").val(args);
                                //alert($("#txtid").val());
                                $('#tblApproval tbody').find('tr').each(function (i) {
                                    var $tds = $(this).find('td'),
                                        productId = $tds.eq(0).text(),
                                        productId = productId.trim();
                                    V = $tds.find('#VerificationLevels').val();
                                    A = $tds.find('#ApprovalLevels').val();

                                    if (parseInt(V) > parseInt(A)) {
                                        Verification = V;
                                    }
                                    else {
                                        Verification = A;
                                    }
                                    //alert('V ' + V);
                                    //alert('A ' + A);
                                    //alert('Verification ' + Verification);

                                });
                                if (Verification > 1) {
                                    var message = "";
                                    var table = document.getElementById("tblOne");
                                    var row = table.rows[1];
                                    for (var k = 0; k < Verification - 1; k++) {
                                        var message = "";
                                        for (var j = 0; j < row.cells.length; j++) {

                                            if (j == 0) {
                                                if (k < V - 1) {
                                                    var cell = row.cells[j];
                                                    message += "<td  valign='middle' align='center' >" + cell.innerHTML + "</td>";
                                                }
                                                else {
                                                    message += "<td  valign='middle' align='center' ></td>";
                                                }
                                            }
                                            else if (j == 1) {
                                                if (k < A - 1) {
                                                    var cell = row.cells[j];
                                                    message += "<td  valign='middle' align='center' >" + cell.innerHTML + "</td>";
                                                }
                                                else {
                                                    message += "<td  valign='middle' align='center' ></td>";
                                                }
                                            }
                                            else {
                                                var cell = row.cells[j];
                                                message += "<td  valign='middle' align='center' >" + cell.innerHTML + "</td>";
                                            }


                                        }
                                        $("#tblOne").append('<tr>' + message + '</tr>');

                                    }

                                    message = "";
                                }
                                 $.getJSON("@Url.Content("~/ApprovalSettings/getdata/")" + args, function (data) {
                                if (data != null && data.length !=0) {
                                    var len = data.length;
                                    //alert('len ' + len);
                                        var values = [];
                                        for (var i = 0; i <len; i++) {

                                         $('#tblOne tbody').find('tr').each(function (j) {
                                         if(i==j)
                                         {
                                         var $tds = $(this).find('td');

                                           if(V=="0")
                                          {
                                           $tds.find('#ddlVerifier').prop("disabled", false);
                                           $tds.find('#ddlVerifier').prop('selectedIndex', 0);
                                           if (data[i].verifier != 0) {
                                               $tds.find('#ddlVerifier').val(data[i].verifier);
                                           }
                                          }
                                          else if(data[i].verifier==0)
                                          {
                                          $tds.find('#ddlVerifier').prop('selectedIndex',0);
                                          }
                                          else
                                         {
                                         $tds.find('#ddlVerifier').val(data[i].verifier);
                                         }
                                           if(A=="0")
                                          {
                                           $tds.find('#ddlApprover').prop("disabled", false);
                                           $tds.find('#ddlApprover').prop('selectedIndex',0);
                                          }
                                         else if(data[i].approver==0)
                                         {
                                            $tds.find('#ddlApprover').prop('selectedIndex',0);
                                         }
                                         else
                                         {
                                         $tds.find('#ddlApprover').val(data[i].approver);
                                         }
                                          $tds.find('#txtAmountFrom').val(data[i].amountFrom);
                                           $tds.find('#txtAmountTo').val(data[i].amountTo);
                                         }
                                         });
                                        }

                                        }
                                        else

                                        {
                                            $('#tblOne tbody').find('tr').each(function (j) {

                                                    var $tds = $(this).find('td');

                                                    if(V=="0")
                                                    {
                                                        $tds.find('#ddlVerifier').prop("disabled", false);
                                                        $tds.find('#ddlVerifier').prop('selectedIndex', 0);
                                                    }
                                                    else
                                                    {
                                                        $tds.find('#ddlVerifier').prop('selectedIndex', 0);
                                                    }
                                                    if(A=="0")
                                                    {
                                                        $tds.find('#ddlApprover').prop("disabled", false);
                                                        $tds.find('#ddlApprover').prop('selectedIndex',0);
                                                    }
                                                    else
                                                    {
                                                        $tds.find('#ddlApprover').prop('selectedIndex', 0);
                                                    }
                                            });
                                        }
                                       });
                                //ddlApprover.empty().append('<option selected="selected" value="0">Please select</option>');
                                //$.each(response, function () {
                                //    if (response.length > 0) {
                                //        $('#ddlApprover').html('');
                                //        var options = '';
                                //        options += '<option value="Select">Select</option>';
                                //        for (var i = 0; i < response.length; i++) {
                                //            options += '<option value="' + response[i] + '">' + response[i] + '</option>';
                                //        }
                                //        $('#ddlApprover').append(options);
                                //    }
                                //});
                            },
                            failure: function (response) {
                                alert(response.responseText);
                            },
                            error: function (response) {
                                alert(response.responseText);
                            }
                        });
                    });






            }
        </script>
    </environment>

    <environment names="Staging,Production">
        <script src="~/_bundles/department.min.js" asp-append-version="true"></script>
    </environment>
}
